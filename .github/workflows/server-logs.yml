name: Server Logs Viewer

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Comando a ejecutar'
        required: true
        type: choice
        options:
          - 'status'
          - 'logs-tail'
          - 'logs-live'
          - 'celery-logs'
          - 'webhook-logs'
          - 'errors'
          - 'all-logs'

jobs:
  view-logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Execute command on server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          case "${{ github.event.inputs.command }}" in
            status)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "sudo systemctl status youtube-whisper --no-pager -l"
              ;;
            logs-tail)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "sudo journalctl -u youtube-whisper -n 100 --no-pager"
              ;;
            logs-live)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "sudo journalctl -u youtube-whisper -n 50 --no-pager"
              ;;
            celery-logs)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "tail -n 100 /home/deploy/Youtube-to-notion-whisper/logs/celery_worker.log"
              ;;
            webhook-logs)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "tail -n 100 /home/deploy/Youtube-to-notion-whisper/logs/webhook_server.log"
              ;;
            errors)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "sudo journalctl -u youtube-whisper -p err..emerg -n 50 --no-pager"
              ;;
            all-logs)
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deploy@100.83.246.78 \
                "tail -n 50 /home/deploy/Youtube-to-notion-whisper/logs/*.log"
              ;;
          esac